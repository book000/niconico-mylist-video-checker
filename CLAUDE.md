# Claude Code 作業方針

## 目的

このファイルは、Claude Code がこのプロジェクトで作業する際の方針とプロジェクト固有ルールを定義します。

## 判断記録のルール

判断は必ずレビュー可能な形で記録すること：

1. **判断内容の要約**: 何を決定したか
2. **検討した代替案**: 他にどのような選択肢があったか
3. **採用しなかった案とその理由**: なぜその案を選ばなかったか
4. **前提条件・仮定・不確実性**: 判断の前提となる条件や仮定
5. **他エージェントによるレビュー可否**: 他エージェントがレビューできる形式か

**重要**: 前提・仮定・不確実性を明示すること。仮定を事実のように扱ってはならない。

## プロジェクト概要

- **プロジェクト名**: niconico-mylist-video-checker
- **目的**: ニコニコ動画のマイリストから新しい動画を取得し、Discord に通知する
- **主な機能**:
  - ニコニコ動画マイリスト API からのデータ取得
  - 新規動画の検出（既通知動画との差分）
  - Discord への通知送信（Embed 形式）
  - 通知済み動画の状態管理

## 重要ルール

- **会話言語**: 日本語
- **コード内コメント**: 日本語
- **エラーメッセージ**: 英語
- **日本語と英数字の間**: 新規追加・更新する日本語テキストでは、日本語と英数字の間に必ず半角スペースを挿入する（既存ドキュメントは原則そのまま・修正時に順次対応）

## 環境のルール

- **Git コミット**: [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に従う
  - `<description>` は日本語で記載
  - 例: `feat: Discord 通知機能を追加`
- **ブランチ命名**: [Conventional Branch](https://conventional-branch.github.io) に従う
  - `<type>/<description>` 形式
  - `<type>` は短縮形（feat, fix, docs 等）を使用
  - 例: `feat/add-notification`
- **GitHub リポジトリ調査**: テンポラリディレクトリに git clone して調査する
- **Renovate PR**: Renovate が作成したプルリクエストに対して、追加コミットや更新を行わない

## コード改修時のルール

- **日本語と英数字の間**: 新規追加・更新する日本語テキストでは、日本語と英数字の間に必ず半角スペースを挿入する（既存ドキュメントは原則そのまま・修正時に順次対応）
- **エラーメッセージの絵文字**: 既存のエラーメッセージに絵文字がある場合、全体で統一する（❌、🆕、🎥 等）
- **TypeScript の `skipLibCheck`**: 有効にして回避することは絶対にしない
- **JSDoc**: 関数やインターフェースには JSDoc を日本語で記載・更新する

## 相談ルール

以下のエージェントに相談できます：

### Codex CLI (ask-codex)

- 実装コードに対するソースコードレビュー
- 関数設計、モジュール内部の実装方針などの局所的な技術判断
- アーキテクチャ、モジュール間契約、パフォーマンス／セキュリティといった全体影響の判断
- 実装の正当性確認、機械的ミスの検出、既存コードとの整合性確認

### Gemini CLI (ask-gemini)

- SaaS 仕様、言語・ランタイムのバージョン差、料金・制限・クォータといった、最新の適切な情報が必要な外部依存の判断
- 外部一次情報の確認、最新仕様の調査、外部前提条件の検証

### 指摘への対応

他エージェントが指摘・異議を提示した場合、以下のいずれかを行う（黙殺・無言での不採用は禁止）：

- 指摘を受け入れ、判断を修正する
- 指摘を退け、その理由を明示する

他エージェントの提案を鵜呑みにせず、根拠や理由を理解し、自身で最終判断を下す。

## 開発コマンド

```bash
# 依存関係のインストール
pnpm install

# アプリケーションの起動
pnpm start

# 開発モード（ファイル監視）
pnpm dev

# Lint 実行（全て）
pnpm lint

# Lint 実行（個別）
pnpm lint:prettier  # Prettier チェック
pnpm lint:eslint    # ESLint チェック
pnpm lint:tsc       # TypeScript 型チェック

# 自動修正
pnpm fix            # Prettier + ESLint 自動修正
pnpm fix:prettier   # Prettier 自動修正
pnpm fix:eslint     # ESLint 自動修正
```

## アーキテクチャと主要ファイル

### ディレクトリ構造

```
.
├── src/
│   ├── main.ts                    # エントリーポイント
│   ├── config.ts                  # 設定管理
│   └── models/
│       ├── niconico-mylist.ts     # マイリストモデル
│       ├── niconico-mylistitem.ts # マイリストアイテムモデル
│       └── response.ts            # API レスポンス型定義
├── data/                          # データディレクトリ（Git 管理外）
│   └── config.json               # Discord 設定
├── .github/                       # GitHub 設定
├── Dockerfile                     # Docker イメージ定義
└── compose.yml                    # Docker Compose 設定
```

### 主要ファイル

- **`src/main.ts`**: メイン処理
  - マイリストデータ取得
  - 新規動画検出
  - Discord 通知
  - 状態管理（通知済み動画 ID）
- **`src/config.ts`**: 設定検証ロジック
- **`src/models/*.ts`**: データモデル定義

## 実装パターン

### 推奨パターン

- **Discord 通知**: `@book000/node-utils` の `Discord` クラスを使用
- **ログ出力**: `@book000/node-utils` の `Logger` クラスを使用
- **HTTP リクエスト**: `axios` を使用
- **エラーメッセージ**: 絵文字を先頭に付ける（❌、🆕、🎥 等）

### 非推奨パターン

- `console.log` の直接使用（Logger を使う）
- ハードコードされた設定値（config.json または環境変数を使う）

## テスト

- **テストフレームワーク**: 現在未設定
- **テスト追加**: プロジェクトオーナーと相談してから追加する

## ドキュメント更新ルール

### 更新対象

- `README.md`: 機能追加や使い方の変更時
- `README-ja.md`: README.md と同じタイミングで更新

### 更新タイミング

- 新機能追加時
- 使用方法の変更時
- 設定項目の追加・変更時

## 作業チェックリスト

### 新規改修時

以下を必ず確認すること：

1. プロジェクトについて詳細に探索し理解すること
2. 作業を行うブランチが適切であること。すでに PR を提出しクローズされたブランチでないこと
3. 最新のリモートブランチに基づいた新規ブランチであること
4. PR がクローズされ、不要となったブランチは削除されていること
5. プロジェクトで指定されたパッケージマネージャ（pnpm）により、依存パッケージをインストールしたこと

### コミット・プッシュ前

以下を必ず確認すること：

1. コミットメッセージが [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に従っていること（`<description>` は日本語）
2. コミット内容にセンシティブな情報（Discord トークン等）が含まれていないこと
3. Lint / Format エラーが発生しないこと（`pnpm lint` が成功すること）
4. 動作確認を行い、期待通り動作すること

### PR 作成前

以下を必ず確認すること：

1. プルリクエストの作成をユーザーから依頼されていること
2. コミット内容にセンシティブな情報が含まれていないこと
3. コンフリクトする恐れが無いこと

### PR 作成後

以下を必ず実施すること（PR 作成後のプッシュ時に毎回実施）：

1. コンフリクトが発生していないこと
2. PR 本文の内容は、ブランチの現在の状態を、今までのこの PR での更新履歴を含むことなく、最新の状態のみ、漏れなく日本語で記載されていること
3. `gh pr checks <PR ID> --watch` で GitHub Actions CI を待ち、その結果がエラーとなっていないこと
4. `request-review-copilot` コマンドが存在する場合、レビューを依頼すること
5. 10 分以内に投稿される GitHub Copilot レビューへの対応を行うこと
6. `/code-review:code-review` によるコードレビューを実施し、信頼度スコアが 50 以上の指摘事項に対して対応すること

## リポジトリ固有

- **Docker 実行環境**: 本番環境では Docker で実行される前提
- **設定ファイル**:
  - `data/config.json`: Discord 設定（token/channelId または webhookUrl）
  - `watch-my-lists.json`: 監視対象のマイリスト ID リスト
  - `mylist.json`: 通知済み動画 ID の状態管理
- **環境変数**:
  - `WATCH_MY_LISTS_PATH`: 監視対象マイリストファイルのパス（デフォルト: `watch-my-lists.json`）
  - `MY_LIST_PATH`: 通知済み動画管理ファイルのパス（デフォルト: `mylist.json`）
- **初回実行**: `mylist.json` が存在しない場合は初期化モードとなり、Discord 通知はスキップされる
- **ページネーション**: マイリストが 100 件を超える場合、自動的に次ページを取得する
- **Renovate**: 依存関係の自動更新に使用。Renovate PR には手を加えない
